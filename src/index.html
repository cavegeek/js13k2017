<html>
<head>
<title>Lost in Space</title>
<style>
td {
  border: 1px solid black;
}
</style>
</head>
<script language="javascript">
var crew = 10;

var tickfrac = 10000; // fraction of a day

function tick() {
  ship.oxygen -= crew*550/tickfrac;
  ship.co2 += crew*550/tickfrac;
  ship.clean_water -= crew*2/tickfrac;
  ship.waste_water += crew*2/tickfrac;
  ship.food -= crew*2/tickfrac;
  ship.distance += 1;
}

function hydroponic() {
  var prod = Math.min(500, Math.max(ship.co2, 0));
  ship.food += prod/250/tickfrac; // Litres of CO2 to kilograms
  ship.oxygen += prod/tickfrac;
  ship.co2 -= prod/tickfrac;
}

function water() {
  if(ship.waste_water > 20/tickfrac) {
    ship.waste_water -= 20/tickfrac;
    ship.clean_water += 20/tickfrac;
  }
}

function oxygen() {
  if(ship.oxygen < rooms.length*50*23.5/100 || ship.co2 > rooms.length*50*0.04/100) {
    ship.oxygen += 3000/tickfrac;
    ship.co2 -= 3000/tickfrac;
  }
}

function empty() {
}

var room_types = [hydroponic, water, oxygen, empty];

function room(func) {
  return {
    reliability: 10,
    action: func
  }
}

rooms = [
water, empty, hydroponic, empty,
empty, oxygen, empty, hydroponic,
empty, empty, oxygen, empty,
hydroponic, empty, empty, empty
].map(room);

ship = {
  oxygen: rooms.length*50*23.5/100, // litres
  co2: rooms.length*50*0.04/100, // litres
  clean_water: 100, // litres
  waste_water: 100, // litres
  food: 100, // kilograms
  distance: 0 // ticks
};

function createRoom(elem, room) {
  var list = elem.appendChild(document.createElement("dl"));
  list.appendChild(document.createElement("dt")).textContent = "type";
  var select = list.appendChild(document.createElement("dd")).appendChild(document.createElement("select"));
  for(var i = 0; i < room_types.length; ++i) {
    var option = select.appendChild(document.createElement("option"))
    option.setAttribute("value", i);
    option.textContent = room_types[i].name;
    if(room.action == room_types[i]) {
      option.setAttribute("selected", "selected");
    }
  }
  list.appendChild(document.createElement("dt")).textContent = "reliability";
  var reliability = list.appendChild(document.createElement("dd"))
  reliability.textContent = room.reliability;
  select.onchange = function() {
    if(room.reliability > 0) {
      --room.reliability;
      room.action = room_types[select.value];
      reliability.textContent = room.reliability;
    }
  };
}

function rooms_tick() {
  for(var i = 0; i < rooms.length; ++i) {
    rooms[i].action();
  }
}

function display_stats() {
  for(var stat in ship) {
    document.getElementById("stat_" + stat).textContent = ship[stat];
  }
}

function run_step() {
  for(var i = 0; i < tickfrac/30; ++i) {
    tick();
    rooms_tick();
    display_stats();
  }
}

window.onload = function () {
  var width = Math.ceil(Math.sqrt(rooms.length));
  var row;
  for(var i = 0; i < rooms.length; ++i) {
    if(i % width == 0) {
      row = document.getElementById("ship").appendChild(document.createElement("tr"));
    }
    var col = row.appendChild(document.createElement("td"));
    col.setAttribute("id", "room" + i);
    createRoom(col, rooms[i]);
  }
  var stats = document.getElementById("stats");
  for(var stat in ship) {
    stats.appendChild(document.createElement("dt")).textContent = stat;
    var data = stats.appendChild(document.createElement("dd"));
    data.setAttribute("id", "stat_" + stat);
    data.textContent = ship[stat];
  }
};
</script>
<style>
</style>
<body>
<header>
<h1>Lost in Space</h1>
</header>
<main>
<button onclick="window.setInterval(run_step, 500); this.disabled=true;">start</button>
<section>
<dl id="stats">
</dl>
</section>
<section>
  <table id="ship">
  </table>
</section>
</main>
</body>
</html>
