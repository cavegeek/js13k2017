<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Lost in Space</title>
<link rel="stylesheet" type="text/css" href="style.css" />
</head>
<script src="rooms.js"></script>
<script>
var crew = {
  up: {
    co2: 550,
    waste_water: 4
  },
  down: {
    oxygen: 550,
    clean_water: 2,
    food: 2
  }
};

var crew_count = 10;
var air_per_room = 50000;

function denull(x) {
  return x ? x : 0;
}

function accum(x, y) {
  for(var i in y) {
    x[i] = denull(x[i]) + y[i];
  }
}

function dccum(x, y) {
  for(var i in y) {
    x[i] = denull(x[i]) - y[i];
  }
}

function calc_scale1(thing) {
  var scale = {};
  for(var i in thing.down) {
    if(denull(thing.up[i]) < 0.001 && thing.down[i] < 0.001) {
      continue;
    }
    if(thing.down[i] > 0) {
      scale[i] = denull(thing.up[i]) / thing.down[i];
    }
  }
  return scale;
}

function scale_of(thing, scale) {
  var scale = 1;
  for(var i in thing.down) {
    if(scale[i]) {
      scale = Math.min(scale, scale[i]);
    }
  }
  return scale;
}

function mul(m, thing) {
  var scaled = {up: {}, down: {}};
  for(var i in thing.up) {
    scaled.up[i] = m*thing.up[i];
  }
  for(var i in thing.down) {
    scaled.down[i] = m*thing.down[i];
  }
  return scaled;
}

function scale_by(scale, thing) {
  var min = 1;
  for(var i in thing.down) {
    if(scale[i]) {
      min = Math.min(min, scale[i]);
    }
  }
  return mul(min, thing);
}

function sum_things(scale) {
  var sum = scale_by(scale, mul(crew_count, crew));
  for(var i = 0; i < rooms.length; ++i) {
    var scaled = scale_by(scale, rooms[i]);
    accum(sum.up, scaled.up);
    accum(sum.down, scaled.down);
  }
  return sum;
}

function combine_scale(scale0, scale1) {
  var combined = {};
  for(var i in scale0) {
    combined[i] = scale1[i] ? scale0[i]*scale1[i] : scale0[i];
  }
  for(var i in scale1) {
    if(!scale0[i]) {
      combined[i] = scale1[i];
    }
  }
  return combined;
}

function unit_scale(scale) {
  for(var i in scale) {
    if(scale[i] < 0.9999) {
      return false;
    }
  }
  return true;
}

function calc_scale() {
  var scale = {};
  var sum = sum_things(scale);
  accum(sum.up, ship);
  var new_scale = calc_scale1(sum);
  while(!unit_scale(new_scale)) {
    scale = combine_scale(scale, new_scale);
    sum = sum_things(scale);
    accum(sum.up, ship);
    new_scale = calc_scale1(sum);
  }
  return scale;
}

function tick() {
  var scale = calc_scale();
  var sum = sum_things(scale);
  accum(ship, sum.up);
  dccum(ship, sum.down);
  ship.days += 1;
}

rooms = [
water, empty, hydroponic, empty,
empty, oxygen, empty, hydroponic,
empty, empty, oxygen, empty,
hydroponic, empty, empty, empty
];

ship = {
  oxygen: rooms.length*air_per_room*23.5/100, // litres
  co2: rooms.length*air_per_room*0.04/100, // litres
  clean_water: 100, // litres
  waste_water: 100, // litres
  food: 100, // kilograms
  days: 0
};

function createRoom(elem, ix) {
  var list = elem.appendChild(document.createElement("dl"));
  list.appendChild(document.createElement("dt")).textContent = "type";
  var select = list.appendChild(document.createElement("dd")).appendChild(document.createElement("select"));
  for(var i = 0; i < room_types.length; ++i) {
    var option = select.appendChild(document.createElement("option"))
    option.setAttribute("value", i);
    option.textContent = room_types[i].name;
    if(rooms[ix].name == room_types[i].name) {
      option.setAttribute("selected", "selected");
    }
  }
  select.onchange= function() {
    rooms[ix] = room_types[select.value];
  }
}

var fmt = Intl.NumberFormat("en-US", {
  minimumIntegerDigits: 3,
  minimumFractionDigits: 2,
  maximumFractionDigits: 2});

function display_stats() {
  for(var stat in ship) {
    document.getElementById("stat_" + stat).textContent = fmt.format(ship[stat]);
  }
}

function run_step() {
  tick();
  display_stats();
}

window.onload = function () {
  var width = Math.ceil(Math.sqrt(rooms.length));
  var row;
  for(var i = 0; i < rooms.length; ++i) {
    if(i % width == 0) {
      row = document.getElementById("ship").appendChild(document.createElement("tr"));
    }
    var col = row.appendChild(document.createElement("td"));
    col.setAttribute("id", "room" + i);
    createRoom(col, i);
  }
  var stats = document.getElementById("stats");
  for(var stat in ship) {
    stats.appendChild(document.createElement("dt")).textContent = stat.replace('_', ' ');
    var data = stats.appendChild(document.createElement("dd"));
    data.setAttribute("id", "stat_" + stat);
  }
  display_stats();
};
</script>
<style>
</style>
<body>
<header>
<h1>Lost in Space</h1>
<button onclick="window.setInterval(run_step, 2000); this.disabled=true;">start</button>
</header>
<main>
<section>
<dl id="stats" class="horizontal">
</dl>
</section>
<section>
  <table id="ship">
  </table>
  <ul id="room_info" class="vertical">
  </ul>
</section>
</main>
</body>
</html>
