<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Lost in Space</title>
<link rel="stylesheet" type="text/css" href="style.css" />
</head>
<script src="rooms.js"></script>
<script src="scale.js"></script>
<script>
var days_per_tick = 0.1;
var air_per_room = 50000;

var crew = {
  up: {
    co2: 550,
    waste_water: 4
  },
  down: {
    oxygen: 550,
    clean_water: 2,
    food: 2
  }
};

rooms = [
water, empty, hydroponic, empty,
empty, oxygen, empty, hydroponic,
empty, empty, oxygen, empty,
hydroponic, empty, empty, empty
];

ship = {
  crew: 10,
  oxygen: rooms.length*air_per_room*23.5/100, // litres
  co2: rooms.length*air_per_room*0.04/100, // litres
  clean_water: 100, // litres
  waste_water: 100, // litres
  food: 100, // kilograms
  days: 0
};

function createRoom(elem, ix) {
  var list = elem.appendChild(document.createElement("dl"));
  list.appendChild(document.createElement("dt")).textContent = "type";
  var select = list.appendChild(document.createElement("dd")).appendChild(document.createElement("select"));
  for(var i = 0; i < room_types.length; ++i) {
    var option = select.appendChild(document.createElement("option"))
    option.setAttribute("value", i);
    option.textContent = room_types[i].name;
    if(rooms[ix].name == room_types[i].name) {
      option.setAttribute("selected", "selected");
    }
  }
  select.onchange= function() {
    rooms[ix] = room_types[select.value];
  }
}

var fmt = Intl.NumberFormat("en-US", {
  minimumIntegerDigits: 3,
  minimumFractionDigits: 2,
  maximumFractionDigits: 2});

function display_stats() {
  for(var stat in ship) {
    document.getElementById("stat_" + stat).textContent =
        fmt.format(ship[stat]);
  }
}

function capn(scale, priority, msg) {
  if(scale && scale < 0.9999) {
    if(Math.random() < priority/10) {
      var log = document.getElementById("log");
      var li = document.createElement("li");
      li.textContent = "Day " + Math.floor(ship.days) + ": " + msg;
      log.insertBefore(li, log.firstChild);
    }
  }
}

function run_step() {
  var scale = calc_scale();
  var sum = sum_things(scale);
  accum(ship, sum.up);
  dccum(ship, sum.down);
  var delta = {};
  accum(delta, sum.up);
  dccum(delta, sum.down);
  ship.days += days_per_tick;
  capn(scale.food, 3,
    "We don't have enough food, hopefully we can grow more in time.");
  capn(scale.co2, 1,
    "Our plants are not growing fast. It looks like they don't have enough co2.");
  capn(scale.oxygen, 10,
    "It is hard to breathe, we are low on oxygen.");
  capn(scale.clean_water, 7,
    "Everyone is thirsty, we're lacking clean water.");
  display_stats();
}

window.onload = function () {
  var width = Math.ceil(Math.sqrt(rooms.length));
  var row;
  for(var i = 0; i < rooms.length; ++i) {
    if(i % width == 0) {
      row = document.getElementById("ship").appendChild(document.createElement("tr"));
    }
    var col = row.appendChild(document.createElement("td"));
    col.setAttribute("id", "room" + i);
    createRoom(col, i);
  }
  var stats = document.getElementById("stats");
  for(var stat in ship) {
    stats.appendChild(document.createElement("dt")).textContent = stat.replace('_', ' ');
    var data = stats.appendChild(document.createElement("dd"));
    data.setAttribute("id", "stat_" + stat);
  }
  display_stats();
};

var updater;

function start() {
  if(updater) {
    window.clearInterval(updater);
    updater = false;
    document.getElementById("start").textContent = "resume";
  } else {
    updater = window.setInterval(run_step, 2000);
    document.getElementById("start").textContent = "pause";
  }
}
</script>
<style>
</style>
<body>
<header>
<h1>Lost in Space</h1>
<button id="start" onclick="start()">start</button>
</header>
<main>
<section>
<dl id="stats" class="horizontal">
</dl>
</section>
<section>
  <table id="ship">
  </table>
  <ul id="room_info" class="vertical">
  </ul>
</section>
<section>
<h1>Captain's Log</h1>
<ul id="log">
<li>Day 0: We were on a routine trade mission when an unexplained malfunction sent our
ship off course in an unknown direction. We appear to be in deep space. We have
no idea where we are, and not enough fuel to turn around. But the survival
instinct is strong, we will live as long as we can on what we have.
</ul>
</section>
</main>
</body>
</html>
